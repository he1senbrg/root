# GraphQL Mutations

## Quick Navigation

- [Overview](1-overview.md)
- [System Architecture](2-system-architecture.md)
  - [Application Configuration](2.1-application-configuration.md)
- [Database Models](3-database-models.md)
  - [Member Model](3.1-member-model.md)
  - [Attendance Model](3.2-attendance-model.md)
  - [Streak Model](3.3-streak-model.md)
  - [Project Model](3.4-project-model.md)
- [GraphQL API](4-graphql-api.md)
  - [GraphQL Queries](4.1-graphql-queries.md)
    - [Member Queries](4.1.1-member-queries.md)
    - [Attendance Queries](4.1.2-attendance-queries.md)
    - [Streak Queries](4.1.3-streak-queries.md)
    - [Project Queries](4.1.4-project-queries.md)
  - [GraphQL Mutations](4.2-graphql-mutations.md)
    - [Member Mutations](4.2.1-member-mutations.md)
    - [Attendance Mutations](4.2.2-attendance-mutations.md)
    - [Streak Mutations](4.2.3-streak-mutations.md)
    - [Project Mutations](4.2.4-project-mutations.md)
- [Background Tasks](5-background-tasks.md)
  - [Daily Attendance Task](5.1-daily-attendance-task.md)
- [Deployment and CI/CD](6-deployment-and-cicd.md)
  - [GitHub Actions Workflows](6.1-github-actions-workflows.md)
  - [Docker Deployment](6.2-docker-deployment.md)
- [Security Features](7-security-features.md)
  - [HMAC Authentication](7.1-hmac-authentication.md)

## Table of Contents

- [GraphQL Mutations](#graphql-mutations)
  - [Introduction](#introduction)
  - [Mutation Structure](#mutation-structure)
  - [Member Mutations](#member-mutations)
    - [createMember](#createmember)
  - [Attendance Mutations](#attendance-mutations)
    - [markAttendance](#markattendance)
  - [Streak Mutations](#streak-mutations)
    - [incrementStreak](#incrementstreak)
    - [resetStreak](#resetstreak)
  - [Project Mutations](#project-mutations)
  - [Authentication and Security](#authentication-and-security)
  - [Database Interaction](#database-interaction)

# GraphQL Mutations

Relevant source files

* [migrations/20250114180047\_create\_tables.sql](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql)
* [src/graphql/mutations/attendance\_mutations.rs](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs)
* [src/graphql/mutations/member\_mutations.rs](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/member_mutations.rs)
* [src/graphql/mutations/streak\_mutations.rs](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs)
* [src/models/member.rs](https://github.com/amfoss/root/blob/2b58803d/src/models/member.rs)

## Introduction

GraphQL Mutations in Root are responsible for write operations that modify data in the PostgreSQL database. They represent the primary way to create, update, or otherwise manipulate data within the system. While [GraphQL Queries](/amfoss/root/4.1-graphql-queries) focus on reading data, mutations handle all data modifications.

This document covers the architecture, implementation, and usage of GraphQL mutations available in the Root system, including those for managing members, attendance records, status update streaks, and projects.

Sources: [src/graphql/mutations/attendance\_mutations.rs1-64](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L1-L64) [src/graphql/mutations/streak\_mutations.rs1-56](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L1-L56) [src/graphql/mutations/member\_mutations.rs1-40](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/member_mutations.rs#L1-L40)

## Mutation Structure

GraphQL mutations in Root are organized by domain area, with separate mutation objects for each entity type. The system implements the following mutation categories:

1. Member Mutations - For creating and managing member records
2. Attendance Mutations - For marking and updating attendance records
3. Streak Mutations - For managing status update streaks
4. Project Mutations - For managing project data

Each mutation type is implemented as a separate Rust struct with methods defining the available operations. These structs are combined into a unified mutation schema available through the GraphQL API.


Sources: [src/graphql/mutations/attendance\_mutations.rs14-18](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L14-L18) [src/graphql/mutations/streak\_mutations.rs8-12](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L8-L12) [src/graphql/mutations/member\_mutations.rs10-14](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/member_mutations.rs#L10-L14)

## Member Mutations

Member mutations handle the creation of new member records in the system.

### createMember

The `createMember` mutation allows the creation of new member records with the following fields:

| Field | Type | Description |
| --- | --- | --- |
| roll\_no | String | Unique roll number identifier |
| name | String | Member's full name |
| email | String | Member's email address (unique) |
| sex | Sex enum | Member's gender (M, F, or Other) |
| year | Int | Academic year (1-4) |
| hostel | String | Member's hostel name |
| mac\_address | String | MAC address for attendance tracking (unique) |
| discord\_id | String | Member's Discord ID (unique) |
| group\_id | Int | Group identifier for member categorization |

The mutation returns the newly created `Member` object, including the auto-generated `member_id`.


Sources: [src/graphql/mutations/member\_mutations.rs14-38](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/member_mutations.rs#L14-L38) [src/models/member.rs30-41](https://github.com/amfoss/root/blob/2b58803d/src/models/member.rs#L30-L41)

## Attendance Mutations

Attendance mutations handle the recording of member attendance. This is a security-sensitive operation, so it implements HMAC-based request verification.

### markAttendance

The `markAttendance` mutation updates a member's attendance record for a specific date, setting their time of entry and exit, and marking them as present. It requires an HMAC signature for verification to prevent unauthorized attendance records.

Input for this mutation includes:

| Field | Type | Description |
| --- | --- | --- |
| member\_id | Int | ID of the member marking attendance |
| date | Date | Date for which attendance is being marked |
| hmac\_signature | String | HMAC signature for security verification |

The mutation returns the updated `Attendance` record.


The HMAC verification process works as follows:

1. The server retrieves the secret key from the context
2. It generates an HMAC signature using SHA256 with the message `{member_id}{date}`
3. It compares the generated signature with the one provided in the request
4. If they match, the attendance record is updated; otherwise, an error is returned

After verification, the mutation updates the attendance record in the database:

* Sets `time_in` if it's the first check-in of the day
* Updates `time_out` to the current time
* Marks the member as present

Sources: [src/graphql/mutations/attendance\_mutations.rs17-63](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L17-L63)

## Streak Mutations

Streak mutations manage status update streaks, which track continuous activity of members.

### incrementStreak

The `incrementStreak` mutation increases a member's current streak by 1 and updates their maximum streak if the new value exceeds the previous maximum.

Input for this mutation includes:

| Field | Type | Description |
| --- | --- | --- |
| member\_id | Int | ID of the member whose streak is being incremented |

The mutation returns the updated `StatusUpdateStreak` record.

### resetStreak

The `resetStreak` mutation resets a member's streak. If the current streak is positive, it sets it to 0; if it's already negative, it decreases it further.

Input for this mutation includes:

| Field | Type | Description |
| --- | --- | --- |
| member\_id | Int | ID of the member whose streak is being reset |

The mutation returns the updated `StatusUpdateStreak` record.


Sources: [src/graphql/mutations/streak\_mutations.rs13-55](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L13-L55)

## Project Mutations

While not provided in the detailed code files, the system architecture indicates that Project mutations are implemented for managing project data. These mutations would handle the creation, updating, and potential deletion of project records associated with members.

Based on the system structure, Project mutations would likely include:

* Creating new projects
* Updating project details
* Associating projects with members
* Potentially archiving or removing projects

## Authentication and Security

Mutations in Root implement security mechanisms to protect sensitive operations. The `markAttendance` mutation specifically uses HMAC-SHA256 for request verification, ensuring that attendance can only be marked by authorized systems with access to the shared secret key.


Sources: [src/graphql/mutations/attendance\_mutations.rs29-43](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L29-L43)

## Database Interaction

All mutations interact with the PostgreSQL database through SQL queries executed via the SQLx library. Each mutation typically:

1. Accesses the database pool from the GraphQL context
2. Constructs and executes an SQL query with parameters from the input
3. Returns the result as a structured GraphQL type

The database schema enforces constraints to maintain data integrity, such as unique constraints on member fields and relationship constraints between tables.

Sources: [src/graphql/mutations/member\_mutations.rs20-35](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/member_mutations.rs#L20-L35) [src/graphql/mutations/attendance\_mutations.rs45-59](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/attendance_mutations.rs#L45-L59) [src/graphql/mutations/streak\_mutations.rs17-31](https://github.com/amfoss/root/blob/2b58803d/src/graphql/mutations/streak_mutations.rs#L17-L31) [migrations/20250114180047\_create\_tables.sql3-66](https://github.com/amfoss/root/blob/2b58803d/migrations/20250114180047_create_tables.sql#L3-L66)